<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BakePro - Professional Baking Supplies</title>
  <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">

  <style>
    /* Grid view (m·∫∑c ƒë·ªãnh) - 3 c·ªôt */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* List view - 1 c·ªôt */
    .products-grid.list-view {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    /* Product card trong list view */
    .products-grid.list-view .product-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 20px;
      gap: 20px;
    }

    .products-grid.list-view .product-image {
      width: 200px;
      height: 200px;
      flex-shrink: 0;
    }

    .products-grid.list-view .product-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }

    .products-grid.list-view .product-description {
      -webkit-line-clamp: 4; /* Hi·ªÉn th·ªã nhi·ªÅu d√≤ng h∆°n ·ªü list view */
    }

    /* Category styles */
    .category-item {
      display: flow-root;
      cursor: pointer;
      transition: 0.25s;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .category-item:hover {
      background: #f5f5f5;
    }

    .sub-category {
      display: none;
      margin-left: 15px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }

    .sub-category.open {
      display: block;
    }

    .category-item.active {
      background: #ffebcc;
      color: #b36b00;
    }

    /* Product description */
    .product-description {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
      color: #555;
    }

    .product-description.expanded {
      -webkit-line-clamp: unset;
    }

    .toggle-description {
      color: #ff9800;
      font-size: 12px;
      cursor: pointer;
      margin-top: 5px;
      font-weight: bold;
    }

    /* View toggle buttons */
    .view-toggle {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .view-btn {
      cursor: pointer;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .view-btn:hover {
      border-color: #ff9800;
    }

    .view-btn.active {
      border-color: #ff9800;
      background: #fff8f0;
    }

    /* Sort dropdown */
    .sort-select {
      cursor: pointer;
      position: relative;
    }

    .sort-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 200px;
      margin-top: 5px;
    }

    .sort-dropdown.show {
      display: block;
    }

    .sort-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sort-option:hover {
      background: #f5f5f5;
    }

    .sort-option.active {
      background: #ffebcc;
      color: #b36b00;
      font-weight: bold;
    }

    /* Price filter styles */
    .price-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 0;
    }

    .price-checkbox {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .price-label {
      cursor: pointer;
      user-select: none;
    }
  </style>

  <th:block th:replace="~{header :: head}"></th:block>
</head>
<body>
<!-- Include SVG Icons -->
<th:block th:replace="~{header :: svg-icons}"></th:block>
<th:block th:replace="~{header :: offcanvas-cart}"></th:block>

<!-- Preloader -->
<div class="preloader-wrapper">
  <div class="preloader"></div>
</div>

<!-- Include Header -->
<th:block th:replace="~{header :: header}"></th:block>

<div class="page-container">
  <main class="main-content">
    <div class="content-wrapper">
      <div class="layout-container">
        <aside class="sidebar">
          <!-- Category Filter -->
          <section class="filter-section">
            <h3 class="filter-title">Filter by Category</h3>
            <ul id="categoryList" class="category-list">
              <!-- Danh m·ª•c s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
            </ul>
          </section>

          <!-- Price Filter -->
          <section class="filter-section">
            <h3 class="filter-title">Price Range</h3>
            <div class="price-filters">
              <label class="price-option">
                <input type="checkbox" class="price-checkbox" data-range="0-25" onchange="applyFilters()">
                <span class="price-label">Under RM25</span>
              </label>
              <label class="price-option">
                <input type="checkbox" class="price-checkbox" data-range="25-50" onchange="applyFilters()">
                <span class="price-label">RM25 - RM50</span>
              </label>
              <label class="price-option">
                <input type="checkbox" class="price-checkbox" data-range="50-100" onchange="applyFilters()">
                <span class="price-label">RM50 - RM100</span>
              </label>
              <label class="price-option">
                <input type="checkbox" class="price-checkbox" data-range="100-999999" onchange="applyFilters()">
                <span class="price-label">Over RM100</span>
              </label>
            </div>
          </section>
        </aside>

        <section class="products-section">
          <div class="products-header">
            <div class="page-title-section">
              <h2 class="page-title">All Products</h2>
              <p class="page-description">Professional baking ingredients and additives for perfect results</p>
            </div>
            <div class="sort-controls">
              <span class="sort-label">Sort by:</span>
              <div class="sort-select" onclick="toggleSortDropdown()">
                <span class="sort-value" id="current-sort">Featured</span>
                <img src="https://api.builder.io/api/v1/image/assets/TEMP/6e24038dc0cfbef1f2e508dae0a7a570c0e8c573?placeholderIfAbsent=true&apiKey=4d372ddcf6154073b7e558cf84611b91"
                     alt="Dropdown" class="dropdown-icon">

                <!-- Sort Dropdown -->
                <div class="sort-dropdown" id="sort-dropdown">
                  <div class="sort-option active" data-sort="featured" onclick="sortProducts('featured')">Featured</div>
                  <div class="sort-option" data-sort="view-high" onclick="sortProducts('view-high')">Most Viewed</div>
                  <div class="sort-option" data-sort="view-low" onclick="sortProducts('view-low')">Least Viewed</div>
                  <div class="sort-option" data-sort="price-low" onclick="sortProducts('price-low')">Price: Low to High</div>
                  <div class="sort-option" data-sort="price-high" onclick="sortProducts('price-high')">Price: High to Low</div>
                </div>
              </div>

              <!-- View Toggle -->
              <div class="view-toggle">
                <div class="view-btn active" id="grid-view-btn" onclick="toggleView('grid')" title="Grid View">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="3" width="7" height="7" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" stroke="currentColor" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="view-btn" id="list-view-btn" onclick="toggleView('list')" title="List View">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2"/>
                    <line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2"/>
                    <line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2"/>
                    <rect x="3" y="4" width="3" height="4" fill="currentColor"/>
                    <rect x="3" y="10" width="3" height="4" fill="currentColor"/>
                    <rect x="3" y="16" width="3" height="4" fill="currentColor"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Products Grid -->
          <div id="products-grid" class="products-grid">
            <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
          </div>

          <!-- Pagination -->
          <nav class="pagination" aria-label="Product pagination">
            <div class="pagination-container">
              <!-- S·∫Ω ƒë∆∞·ª£c render b·ªüi JS -->
            </div>
          </nav>
        </section>
      </div>
    </div>
  </main>
</div>

<th:block th:replace="~{header :: scripts}"></th:block>

<script>
  // ==================== GLOBAL STATE ====================
  let currentPage = 1;
  const pageSize = 6;
  let allProducts = [];
  let filteredProducts = [];
  let currentView = 'grid'; // 'grid' or 'list'
  let currentSort = 'featured';
  let selectedPriceRanges = [];

  // ==================== LOAD CATEGORIES ====================
  async function loadCategories() {
    try {
      const res = await fetch("http://localhost:8080/api/categories");
      const categories = await res.json();

      const list = document.getElementById("categoryList");
      list.innerHTML = "";

      categories.forEach(cat => {
        const parentLi = document.createElement("li");
        parentLi.className = "category-item";
        parentLi.innerHTML = `<span>${cat.name}</span>`;
        parentLi.dataset.id = cat.id;

        list.appendChild(parentLi);

        if (cat.children && cat.children.length > 0) {
          const subUl = document.createElement("ul");
          subUl.className = "sub-category";

          parentLi.addEventListener("click", (e) => {
            e.stopPropagation();
            document.querySelectorAll(".sub-category").forEach(ul => {
              if (ul !== subUl) ul.classList.remove("open");
            });
            document.querySelectorAll(".category-item").forEach(item => {
              if (item !== parentLi) item.classList.remove("open");
            });
            subUl.classList.toggle("open");
            parentLi.classList.toggle("open");
          });

          cat.children.forEach(child => {
            const childLi = document.createElement("li");
            childLi.className = "category-item";
            childLi.textContent = child.name;
            childLi.dataset.id = child.id;

            childLi.addEventListener("click", (e) => {
              e.stopPropagation();

              // Highlight active category
              document.querySelectorAll(".category-item").forEach(item => {
                item.classList.remove("active");
              });
              childLi.classList.add("active");

              loadProductsByCategory(child.id);
            });

            subUl.appendChild(childLi);
          });

          parentLi.appendChild(subUl);
        }
      });

    } catch (err) {
      console.error("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c:", err);
    }
  }

  // ==================== LOAD PRODUCTS ====================
  async function loadFeaturedProducts() {
    try {
      const res = await fetch("http://localhost:8080/api/products/list-products");
      allProducts = await res.json() || [];
      applyFilters();
    } catch (error) {
      console.error("Error loading products:", error);
    }
  }

  async function loadProductsByCategory(categoryId) {
    try {
      const res = await fetch(`http://localhost:8080/api/products/by-category/${categoryId}`);
      allProducts = await res.json() || [];
      applyFilters();
    } catch (error) {
      console.error("Error loading products:", error);
      alert("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m!");
    }
  }

  // ==================== FILTER BY PRICE ====================
  function applyFilters() {
    // Get selected price ranges
    selectedPriceRanges = Array.from(document.querySelectorAll('.price-checkbox:checked'))
            .map(cb => cb.dataset.range);

    // Filter products
    if (selectedPriceRanges.length === 0) {
      filteredProducts = [...allProducts];
    } else {
      filteredProducts = allProducts.filter(product => {
        const price = product.minPrice || 0;
        return selectedPriceRanges.some(range => {
          const [min, max] = range.split('-').map(Number);
          return price >= min && price <= max;
        });
      });
    }

    // Apply current sort
    applySorting();

    // Reset to page 1
    currentPage = 1;
    renderProductsPagination();
  }

  // ==================== SORT PRODUCTS ====================
  function toggleSortDropdown() {
    const dropdown = document.getElementById('sort-dropdown');
    dropdown.classList.toggle('show');
  }

  function sortProducts(sortType) {
    currentSort = sortType;

    // Update UI
    document.querySelectorAll('.sort-option').forEach(opt => {
      opt.classList.remove('active');
    });
    document.querySelector(`[data-sort="${sortType}"]`).classList.add('active');

    // Update label
    const sortLabels = {
      'featured': 'Featured',
      'view-high': 'Most Viewed',
      'view-low': 'Least Viewed',
      'price-low': 'Price: Low to High',
      'price-high': 'Price: High to Low'
    };
    document.getElementById('current-sort').textContent = sortLabels[sortType];

    // Close dropdown
    document.getElementById('sort-dropdown').classList.remove('show');

    // Apply sorting
    applySorting();
    currentPage = 1;
    renderProductsPagination();
  }

  function applySorting() {
    switch(currentSort) {
      case 'view-high':
        filteredProducts.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
        break;
      case 'view-low':
        filteredProducts.sort((a, b) => (a.viewCount || 0) - (b.viewCount || 0));
        break;
      case 'price-low':
        filteredProducts.sort((a, b) => (a.minPrice || 0) - (b.minPrice || 0));
        break;
      case 'price-high':
        filteredProducts.sort((a, b) => (b.minPrice || 0) - (a.minPrice || 0));
        break;
      case 'featured':
      default:
        // Keep original order or sort by featured flag
        filteredProducts.sort((a, b) => {
          if (a.isFeatured && !b.isFeatured) return -1;
          if (!a.isFeatured && b.isFeatured) return 1;
          return 0;
        });
    }
  }

  // ==================== TOGGLE VIEW (GRID/LIST) ====================
  function toggleView(view) {
    currentView = view;
    const grid = document.getElementById('products-grid');
    const gridBtn = document.getElementById('grid-view-btn');
    const listBtn = document.getElementById('list-view-btn');

    if (view === 'grid') {
      grid.classList.remove('list-view');
      gridBtn.classList.add('active');
      listBtn.classList.remove('active');
    } else {
      grid.classList.add('list-view');
      listBtn.classList.add('active');
      gridBtn.classList.remove('active');
    }

    // Re-render products v·ªõi view m·ªõi
    renderProductsPagination();
  }

  // ==================== RENDER PRODUCTS ====================
  function renderProducts(products) {
    const productsGrid = document.getElementById("products-grid");
    productsGrid.innerHTML = "";

    if (!products || products.length === 0) {
      productsGrid.innerHTML = "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m</p>";
      return;
    }

    products.forEach(product => {
      const item = document.createElement("article");
      item.classList.add("product-card");

      // Format gi√°
      let priceDisplay = "RM0";
      if (product.minPrice !== null && product.maxPrice !== null) {
        if (product.minPrice === product.maxPrice) {
          priceDisplay = `RM${Number(product.minPrice).toFixed(2)}`;
        } else {
          priceDisplay = `RM${Number(product.minPrice).toFixed(2)} - RM${Number(product.maxPrice).toFixed(2)}`;
        }
      }

      item.innerHTML = `
        <div class="product-click-area" onclick="viewProductDetail(${product.productId})">
          <img src="${product.mainImageUrl || '/img/default.png'}"
               alt="${product.productName}" class="product-image">

          <div class="product-info">
            <h3 class="product-title">${product.productName}</h3>
            <p class="product-description" id="desc-${product.productId}">
              ${product.description || ""}
            </p>
            <span class="toggle-description" onclick="event.stopPropagation(); toggleDescription(${product.productId})">
              Xem th√™m
            </span>

            <div class="product-footer">
              <span class="product-price">${priceDisplay}</span>
              ${product.viewCount ? `<small style="color: #999;">üëÅÔ∏è ${product.viewCount} views</small>` : ''}
              <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart(${product.productId})">
                üõí Add to Cart
              </button>
            </div>
          </div>
        </div>`;

      productsGrid.appendChild(item);
    });
  }

  function renderProductsPagination() {
    const start = (currentPage - 1) * pageSize;
    const paginated = filteredProducts.slice(start, start + pageSize);
    renderProducts(paginated);
    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredProducts.length / pageSize);
    const pagination = document.querySelector(".pagination-container");
    if (!pagination) return;

    pagination.innerHTML = `
      <button class="pagination-arrow" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">‚óÄ</button>
      ${Array.from({ length: totalPages }, (_, i) => `
        <button class="pagination-btn ${currentPage === i + 1 ? 'active' : ''}" onclick="changePage(${i + 1})">${i + 1}</button>
      `).join("")}
      <button class="pagination-arrow" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">‚ñ∂</button>
    `;
  }

  function changePage(page) {
    const totalPages = Math.ceil(filteredProducts.length / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderProductsPagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ==================== HELPER FUNCTIONS ====================
  function toggleDescription(id) {
    const desc = document.getElementById(`desc-${id}`);
    const btn = desc.nextElementSibling;

    if (desc.classList.contains("expanded")) {
      desc.classList.remove("expanded");
      btn.textContent = "Xem th√™m";
    } else {
      desc.classList.add("expanded");
      btn.textContent = "Thu g·ªçn";
    }
  }

  function addToCart(productId) {
    alert("Th√™m s·∫£n ph·∫©m " + productId + " v√†o gi·ªè h√†ng ‚úÖ");
  }

  function viewProductDetail(productId) {
    window.location.href = `/products/${productId}`;
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.sort-select')) {
      document.getElementById('sort-dropdown').classList.remove('show');
    }
  });

  // ==================== INITIALIZE ====================
  document.addEventListener("DOMContentLoaded", function () {
    loadCategories();
    loadFeaturedProducts();
  });
</script>

</body>
</html>